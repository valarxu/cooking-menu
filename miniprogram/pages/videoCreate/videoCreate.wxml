<view class="video-create-container">
  <!-- æ­¥éª¤é›¶ï¼šå†…å®¹è¡¨å• -->
  <view wx:if="{{step === 0 && showContentForm}}">
    <view class="step-title">
      {{videoType === 'product' ? 'äº§å“æ¨å¹¿ä¿¡æ¯' : videoType === 'activity' ? 'æ´»åŠ¨å®£ä¼ ä¿¡æ¯' : 'äººè®¾æ‰“é€ ä¿¡æ¯'}}
    </view>
    
    <!-- äº§å“æ¨å¹¿ - å•†å“é€‰æ‹© -->
    <view class="section" wx:if="{{videoType === 'product'}}">
      <view class="section-title">é€‰æ‹©å•†å“</view>
      <view class="product-selector" wx:if="{{products.length > 0}}">
        <view class="selector-input" bindtap="showProductSelector">
          <text class="selector-text {{selectedProductName ? '' : 'placeholder'}}">{{selectedProductName || 'è¯·é€‰æ‹©å•†å“'}}</text>
          <text class="selector-arrow">></text>
        </view>
      </view>
      <view class="empty-tip" wx:else>
        <text>æš‚æ— å•†å“ï¼Œè¯·å…ˆåˆ°äº§å“ç®¡ç†æ·»åŠ å•†å“</text>
      </view>
    </view>

    <!-- äº§å“æ¨å¹¿ - äº§å“ä¿¡æ¯ -->
    <view class="section" wx:if="{{videoType === 'product'}}">
      <view class="section-title">äº§å“ä¿¡æ¯</view>
      <textarea 
        class="textarea-input"
        placeholder="è¯·è¾“å…¥äº§å“çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ï¼šäº§å“ç‰¹è‰²ã€å–ç‚¹ã€ä½¿ç”¨åœºæ™¯ç­‰"
        value="{{productInfo}}"
        bindinput="onProductInfoInput"
        maxlength="300"
      ></textarea>
    </view>

    <!-- åº—å†…æ´»åŠ¨å®£ä¼  - æ´»åŠ¨ä¼˜æƒ æ”¿ç­– -->
    <view class="section" wx:if="{{videoType === 'activity'}}">
      <view class="section-title">æ´»åŠ¨ä¼˜æƒ æ”¿ç­–</view>
      <textarea 
        class="textarea-input"
        placeholder="è¯·è¾“å…¥æ´»åŠ¨ä¼˜æƒ æ”¿ç­–ï¼Œå¦‚ï¼šå…¨åœº8æŠ˜ã€ä¹°äºŒé€ä¸€ç­‰"
        value="{{activityPolicy}}"
        bindinput="onActivityPolicyInput"
        maxlength="200"
      ></textarea>
    </view>

    <!-- åº—å†…æ´»åŠ¨å®£ä¼  - åº—é“ºä¿¡æ¯ -->
    <view class="section" wx:if="{{videoType === 'activity'}}">
      <view class="section-title">é—¨åº—ä¿¡æ¯</view>
      <textarea 
        class="textarea-input"
        placeholder="è¯·è¾“å…¥é—¨åº—ä¿¡æ¯ï¼Œå¦‚ï¼šé—¨åº—åç§°ã€è£…ä¿®é£æ ¼ã€ç»è¥ç‰¹è‰²ã€æœåŠ¡ç†å¿µç­‰"
        value="{{shopInfo}}"
        bindinput="onShopInfoInput"
        maxlength="300"
      ></textarea>
    </view>

    <!-- äººè®¾æ‰“é€  - è€æ¿ä¿¡æ¯ -->
    <view class="section" wx:if="{{videoType === 'persona'}}">
      <view class="section-title">è€æ¿ä¿¡æ¯</view>
      <textarea 
        class="textarea-input"
        placeholder="è¯·è¾“å…¥è€æ¿ä¿¡æ¯ï¼Œå¦‚ï¼šä¸ªäººç»å†ã€åˆ›ä¸šæ•…äº‹ã€ç»è¥ç†å¿µã€æ€§æ ¼ç‰¹ç‚¹ç­‰"
        value="{{bossInfo}}"
        bindinput="onBossInfoInput"
        maxlength="300"
      ></textarea>
    </view>

    <!-- äººè®¾æ‰“é€  - é—¨åº—ä¿¡æ¯ -->
  <view class="section" wx:if="{{videoType === 'persona'}}">
    <view class="section-title">é—¨åº—ä¿¡æ¯</view>
    <textarea 
      class="textarea-input"
      placeholder="è¯·è¾“å…¥é—¨åº—ä¿¡æ¯ï¼Œå¦‚ï¼šé—¨åº—åç§°ã€è£…ä¿®é£æ ¼ã€ç»è¥ç‰¹è‰²ã€æœåŠ¡ç†å¿µç­‰"
      value="{{shopInfo}}"
      bindinput="onShopInfoInput"
      maxlength="300"
    ></textarea>
  </view>

  <!-- ç”¨æˆ·éœ€æ±‚è¾“å…¥ -->
  <view class="section" wx:if="{{videoType === 'product' || videoType === 'activity' || videoType === 'persona'}}">
    <view class="section-title">ç”¨æˆ·éœ€æ±‚</view>
    <textarea 
      class="textarea-input"
      placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚ï¼Œå¦‚ï¼šçªå‡ºäº§å“ç‰¹è‰²ã€å¸å¼•å¹´è½»ç”¨æˆ·ã€è¥é€ æ¸©é¦¨æ°›å›´ç­‰"
      value="{{userRequirement}}"
      bindinput="onUserRequirementInput"
      maxlength="300"
    ></textarea>
  </view>

    <!-- ç”ŸæˆæŒ‰é’® -->
    <view class="btn-container">
      <my-button type="primary" bindtap="generateContent" loading="{{contentFormLoading}}">
        {{contentFormLoading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆæ–‡æ¡ˆ'}}
      </my-button>
    </view>

    <!-- ç”Ÿæˆç»“æœ -->
    <view class="result-section" wx:if="{{outputText}}">
      <view class="section-title">ç”Ÿæˆçš„æ–‡æ¡ˆ</view>
      <view class="result-content">
        <text class="result-text">{{outputText}}</text>
      </view>
      <view class="btn-container">
        <my-button type="primary" bindtap="proceedToTextInput">ä¸‹ä¸€æ­¥</my-button>
      </view>
    </view>
  </view>

  <!-- æ­¥éª¤ä¸€ï¼šæ–‡æ¡ˆè¾“å…¥ -->
  <view wx:if="{{step === 1}}">
    <view class="step-title">è¾“å…¥æ–‡æ¡ˆï¼Œç”Ÿæˆåˆ†é•œ</view>
    <textarea class="text-input" placeholder="è¯·è¾“å…¥æ–‡æ¡ˆ" value="{{text}}" bindinput="onTextInput" maxlength="{{-1}}"></textarea>
    <view class="btn-container">
      <!-- <my-button wx:if="{{!text}}" type="primary" type="outline" bindtap="onAIGenerate">ç”¨AIç”Ÿæˆ</my-button> -->
      <my-button type="primary" bindtap="nextStep">ä¸‹ä¸€æ­¥</my-button>
    </view>
  </view>

  <!-- æ­¥éª¤äºŒï¼šå£°éŸ³é€‰æ‹© -->
  <view wx:if="{{step === 2}}">
    <view class="step-title">é€‰æ‹©å£°éŸ³</view>
    
    <!-- å£°éŸ³åˆ—è¡¨ -->
    <view class="voice-list">
      <view class="voice-items">
        <view class="voice-item {{selectedVoiceId === item.id ? 'selected' : ''}}" wx:for="{{voiceList}}" wx:key="id" data-voice-id="{{item.id}}" bindtap="selectVoice">
          <view class="voice-info">
            <image class="voice-avatar" src="{{item.avatar}}" mode="aspectFill"></image>
            <view class="voice-details">
              <view class="voice-name-wrapper">
                <text class="voice-name">{{item.name}}</text>
                <text class="cloned-badge" wx:if="{{item.isCloned}}">æˆ‘çš„</text>
              </view>
              <text class="voice-desc">{{item.description}}</text>
            </view>
          </view>
          <view class="voice-actions">
            <button class="play-btn {{playingVoiceId === item.id ? 'playing' : ''}}" data-voice-id="{{item.id}}" data-audio-url="{{item.sampleUrl}}" catchtap="playVoiceSample" size="mini">
              {{playingVoiceId === item.id ? 'æš‚åœ' : 'è¯•å¬'}}
            </button>
          </view>
        </view>
        
        <!-- ä¸Šä¼ é…éŸ³é€‰é¡¹ -->
        <view class="voice-item {{selectedVoiceId === 'upload' ? 'selected' : ''}}" data-voice-id="upload" bindtap="selectVoice">
          <view class="voice-info">
            <image class="voice-avatar" src="/images/avatar/male1.svg" mode="aspectFill"></image>
            <view class="voice-details">
              <view class="voice-name-wrapper">
                <text class="voice-name">ä¸Šä¼ é…éŸ³</text>
              </view>
              <text class="voice-desc">{{uploadedVoiceFile ? uploadedVoiceFile.name || 'å·²é€‰æ‹©éŸ³é¢‘æ–‡ä»¶' : 'ä¸Šä¼ æ‚¨è‡ªå·±çš„é…éŸ³æ–‡ä»¶'}}</text>
            </view>
          </view>
          <view class="voice-actions">
            <button class="upload-btn" bindtap="uploadVoiceFile" size="mini">
              {{uploadedVoiceFile ? 'é‡æ–°é€‰æ‹©' : 'é€‰æ‹©æ–‡ä»¶'}}
            </button>
          </view>
        </view>
      </view>
    </view>
    
    <view class="btn-container">
      <my-button type="outline" bindtap="prevStep">ä¸Šä¸€æ­¥</my-button>
      <my-button type="primary" bindtap="nextStep">ä¸‹ä¸€æ­¥</my-button>
    </view>
  </view>

  <!-- æ­¥éª¤ä¸‰ï¼šè§†é¢‘åˆ†é•œé€‰æ‹© -->
  <view wx:if="{{step === 3}}" class="step-content">
    <view class="section-title">è§†é¢‘åˆ†é•œ</view>
    <view class="section-subtitle">ä¸ºæ¯ä¸ªåˆ†é•œé€‰æ‹©å¯¹åº”çš„è§†é¢‘ç´ æï¼š</view>
    
    <view class="segment-list">
      <view wx:for="{{textSegments}}" wx:key="index" class="segment-item">
        <view class="segment-header">
          <view class="segment-type">{{item.type}}</view>
          <view class="segment-index">åˆ†é•œ {{index + 1}}</view>
        </view>
        
        <view class="segment-text">
          <text>{{item.text}}</text>
        </view>
        
        <view class="segment-video-selector">
          <view class="selector-label">{{item.type === 'äººç‰©å‡ºé•œ' ? 'æ•°å­—äººè§†é¢‘ï¼š' : 'è§†é¢‘ç´ æï¼š'}}</view>
          
          <!-- ç»Ÿä¸€çš„è§†é¢‘é€‰æ‹©å™¨ï¼ˆåŒ…æ‹¬äººç‰©å‡ºé•œç±»å‹ï¼‰ -->
          <view class="video-selector">
            <!-- å·²é€‰æ‹©è§†é¢‘çš„é¢„è§ˆ -->
            <view wx:if="{{item.selectedVideo}}" class="selected-video">
              <video class="preview-video" src="{{item.selectedVideo.url}}" controls></video>
              <view class="video-info">
                <text class="video-name">{{item.selectedVideo.name}}</text>
                <text wx:if="{{item.type !== 'äººç‰©å‡ºé•œ'}}" class="video-type">ç±»å‹ï¼š{{item.selectedVideo.type}}</text>
                <text wx:if="{{item.type !== 'äººç‰©å‡ºé•œ'}}" class="video-product">å…³è”äº§å“ï¼š{{item.selectedVideo.productName}}</text>
                <text wx:if="{{item.type === 'äººç‰©å‡ºé•œ'}}" class="video-size">å¤§å°ï¼š{{item.selectedVideo.size}}MB</text>
                <text wx:if="{{item.type === 'äººç‰©å‡ºé•œ'}}" class="video-duration">æ—¶é•¿ï¼š{{item.selectedVideo.duration}}ç§’</text>
              </view>
              <button class="reselect-btn" bindtap="showVideoSelector" data-index="{{index}}">é‡æ–°é€‰æ‹©</button>
            </view>
            
            <!-- æœªé€‰æ‹©è§†é¢‘çš„æç¤º -->
            <view wx:else class="no-video">
              <view class="no-video-tip">
                <text class="no-video-icon">ğŸ“¹</text>
                <text class="no-video-text">{{item.type === 'äººç‰©å‡ºé•œ' ? 'æš‚æœªé€‰æ‹©æ•°å­—äººè§†é¢‘' : 'æš‚æœªé€‰æ‹©è§†é¢‘'}}</text>
              </view>
              <button class="select-btn" bindtap="showVideoSelector" data-index="{{index}}">{{item.type === 'äººç‰©å‡ºé•œ' ? 'é€‰æ‹©æ•°å­—äººè§†é¢‘' : 'é€‰æ‹©è§†é¢‘'}}</button>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <view class="btn-container">
      <my-button type="outline" bindtap="prevStep">ä¸Šä¸€æ­¥</my-button>
      <my-button type="primary" bindtap="onGenerateVideo" disabled="{{isGenerating}}">{{isGenerating ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆè§†é¢‘'}}</my-button>
    </view>
    
    <!-- ä»»åŠ¡çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
     <view class="task-status-section" wx:if="{{videoTasks.length > 0}}">
       <view class="section-header">
         <text class="section-title">è§†é¢‘ç”Ÿæˆä»»åŠ¡</text>
         <view class="refresh-btn" bindtap="refreshTaskStatus" size="mini">åˆ·æ–°çŠ¶æ€</view>
       </view>
       
       <view class="task-list">
         <view class="task-item" wx:for="{{videoTasks}}" wx:key="_id">
           <view class="task-header">
             <text class="task-time">{{item.created_at}}</text>
             <view class="task-status-wrapper">
               <text class="task-type">{{item.task_type === 'whisper-to-video' ? 'é…éŸ³è§†é¢‘' : 'æ•°å­—äººè§†é¢‘'}}</text>
               <text class="task-status {{item.status}}">{{item.status === 'completed' ? 'å·²å®Œæˆ' : item.status === 'processing' ? 'ç”Ÿæˆä¸­' : 'è¿›è¡Œä¸­'}}</text>
               <text class="task-progress" wx:if="{{item.status === 'processing' && item.task_type !== 'whisper-to-video'}}">{{item.completed_tasks || 0}}/{{item.total_tasks || 0}}</text>
             </view>
           </view>
           
           <!-- è¿›åº¦æ¡ -->
           <view class="progress-bar" wx:if="{{item.status === 'processing'}}">
             <view class="progress-fill" style="width: {{item.progress || 0}}"></view>
           </view>
           
           <!-- whisper-to-videoä»»åŠ¡æ˜¾ç¤º -->
           <view wx:if="{{item.task_type === 'whisper-to-video'}}" class="whisper-task-info">
             <view class="task-info">
               <text class="task-label">é…éŸ³æ–‡ä»¶ï¼š</text>
               <text class="task-value">å·²ä¸Šä¼ </text>
             </view>
             <view wx:if="{{item.status === 'completed' && item.local_video_url}}" class="video-result">
               <video class="result-video" src="{{item.local_video_url}}" controls></video>
             </view>
           </view>
           
           <!-- æ™®é€šä»»åŠ¡çš„éŸ³é¢‘ç»“æœæ˜¾ç¤º -->
           <view wx:else class="audio-results">
             <view class="audio-item" wx:for="{{item.audio_results}}" wx:for-item="audio" wx:key="taskId">
               <view class="audio-info">
                 <text class="audio-type">{{audio.type}}</text>
                 <text class="audio-text">{{audio.text}}</text>
               </view>
               <view class="audio-status">
                 <text class="status-text {{audio.status}}">
                   {{audio.status === 'completed' ? 'âœ“' : audio.status === 'pending' ? 'â³' : audio.status === 'processing' ? 'ğŸ”„' : 'âœ—'}}
                 </text>
                 <button wx:if="{{audio.audioUrl}}" class="play-audio-btn" data-url="{{audio.audioUrl}}" bindtap="playGeneratedAudio" size="mini">æ’­æ”¾</button>
               </view>
             </view>
           </view>
         </view>
       </view>
     </view>
  </view>
  
  <!-- è§†é¢‘é€‰æ‹©å¼¹çª— -->
  <view class="video-selector-modal {{showVideoModal ? 'show' : ''}}" wx:if="{{showVideoModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">{{textSegments[currentSegmentIndex] && textSegments[currentSegmentIndex].type === 'äººç‰©å‡ºé•œ' ? 'é€‰æ‹©æ•°å­—äººè§†é¢‘' : 'é€‰æ‹©è§†é¢‘ç´ æ'}}</text>
        <text class="modal-close" bindtap="hideVideoSelector">Ã—</text>
      </view>
      
      <view class="modal-body">
        <!-- äººç‰©å‡ºé•œç±»å‹æ˜¾ç¤ºæ•°å­—äººè§†é¢‘åˆ—è¡¨ -->
        <view wx:if="{{textSegments[currentSegmentIndex] && textSegments[currentSegmentIndex].type === 'äººç‰©å‡ºé•œ'}}">
          <view wx:if="{{digitalHumanList.length > 0}}" class="video-grid">
            <view 
              wx:for="{{digitalHumanList}}" 
              wx:key="_id" 
              class="grid-video-item {{selectedModalVideoId === item._id ? 'selected' : ''}}"
              bindtap="selectModalVideo"
              data-video-id="{{item._id}}"
            >
              <view class="video-thumbnail">
                <video 
                  class="thumbnail-video" 
                  src="{{item.fileID}}" 
                  show-center-play-btn="{{false}}"
                  show-play-btn="{{false}}"
                  muted
                ></video>
                <view wx:if="{{selectedModalVideoId === item._id}}" class="select-overlay">
                  <text class="check-icon">âœ“</text>
                </view>
              </view>
              
              <view class="grid-video-info">
                <text class="grid-video-name">{{item.name}}</text>
                <view class="grid-video-meta">
                  <text class="grid-video-size">å¤§å°ï¼š{{item.size}}MB</text>
                  <text class="grid-video-duration">æ—¶é•¿ï¼š{{item.duration}}ç§’</text>
                </view>
              </view>
            </view>
          </view>
          
          <view wx:else class="no-material">
            <text class="no-material-text">æš‚æ— æ•°å­—äººè§†é¢‘ï¼Œè¯·å…ˆä¸Šä¼ æ•°å­—äººè§†é¢‘</text>
          </view>
        </view>
        
        <!-- å…¶ä»–ç±»å‹æ˜¾ç¤ºæ™®é€šç´ æåˆ—è¡¨ -->
        <view wx:else>
          <view wx:if="{{materialList.length > 0}}" class="video-grid">
            <view 
              wx:for="{{materialList}}" 
              wx:key="_id" 
              class="grid-video-item {{selectedModalVideoId === item._id ? 'selected' : ''}}"
              bindtap="selectModalVideo"
              data-video-id="{{item._id}}"
            >
              <view class="video-thumbnail">
                <video 
                  class="thumbnail-video" 
                  src="{{item.fileID}}" 
                  show-center-play-btn="{{false}}"
                  show-play-btn="{{false}}"
                  muted
                ></video>
                <view wx:if="{{selectedModalVideoId === item._id}}" class="select-overlay">
                  <text class="check-icon">âœ“</text>
                </view>
              </view>
              
              <view class="grid-video-info">
                <text class="grid-video-name">{{item.name}}</text>
                <view class="grid-video-meta">
                  <text class="grid-video-type" wx:if="{{item.type}}">ç±»å‹ï¼š{{item.type}}</text>
                  <text class="grid-video-product" wx:if="{{item.productName}}">å…³è”ï¼š{{item.productName}}</text>
                </view>
              </view>
            </view>
          </view>
          
          <view wx:else class="no-material">
            <text class="no-material-text">æš‚æ— è§†é¢‘ç´ æï¼Œè¯·å…ˆä¸Šä¼ ç´ æ</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="cancel-btn" bindtap="hideVideoSelector">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="confirmVideoSelection" disabled="{{!selectedModalVideoId}}">ç¡®è®¤é€‰æ‹©</button>
      </view>
    </view>
  </view>

  <!-- å•†å“é€‰æ‹©å¼¹çª— -->
  <view class="product-picker-mask" wx:if="{{showProductPicker}}" bindtap="closeProductPicker">
    <view class="product-picker" catchtap="stopPropagation">
      <view class="picker-header">
        <view class="picker-title">é€‰æ‹©å•†å“</view>
        <view class="picker-close" bindtap="closeProductPicker">Ã—</view>
      </view>
      <view class="picker-content">
        <view 
          class="picker-item {{selectedProduct === item._id ? 'selected' : ''}}"
          wx:for="{{products}}"
          wx:key="_id"
          data-product-id="{{item._id}}"
          data-product-name="{{item.name}}"
          bindtap="selectProduct"
        >
          <view class="picker-item-info">
            <text class="picker-item-name">{{item.name}}</text>
            <text class="picker-item-desc">{{item.description || 'æš‚æ— æè¿°'}}</text>
          </view>
          <view class="picker-item-check" wx:if="{{selectedProduct === item._id}}">
            <text class="check-icon">âœ“</text>
          </view>
        </view>
        <view class="empty-tip" wx:if="{{products.length === 0}}">
          æš‚æ— å•†å“æ•°æ®
        </view>
      </view>
    </view>
  </view>
</view>